<!-- json usage from https://codepen.io/KryptoniteDove/post/load-json-file-locally-using-pure-javascript
-->

<!DOCTYPE html>
<html>
<head>
<title>Game</title>
<style>
table, th, td {
    border: 1px solid black;
    border-collapse: collapse;
    font-size: 100%;
}
th, td {
    padding: 5px;
    text-align: left;    
}
h1 { font-size: 120%; }
h2 { font-size: 120%; }
h3 { font-size: 120%; }
h4 { font-size: 120%; }
p { font-size: 120%; }
select { font-size: 120%; }
button { font-size: 120%; }
form { font-size: 120%; }
input { font-size: 120%; }
</style>

</head>
<body>

<!-- Network Configuration 
-->
<p><h3>Network configuration</h3></p>
<select id="network" name="form_select">
   <option value="0">none</option>
   <option value ="1">wifi</option>
   <option value ="2">ethernet</option>
</select>

<!-- Network::wifi Configuration 
-->
<div id="div_wifi" style="display: none;">
<p><h4>Wifi Setting</h4></p>
<form id="form_wifi"></form>
<button onclick="update_wifi()">Update</button>
</div>

<!-- Network::ethernet Configuration 
-->
<div id="div_ethernet" style="display: none;">
<p><h4>Ethernet Setting</h4></p>
<form id="form_ethernet"></form>
<button onclick="update_ethernet()">Update</button>
</div>

<!-- Others or Tests 
-->
<p><h3>Other configuration</h3></p>

<p id="debug"></p>
<p id="return"></p>




<script>

var filePath = "setting.json"
var outstring = "";
var jsonobj = null;

document.getElementById('network').addEventListener('change', function () {
                refresh_network_ui(this);
            });

network_default_select();

function refresh_network_ui(element) {    
    var style_wifi = element.value == 1 ? 'block' : 'none';
    document.getElementById('div_wifi').style.display = style_wifi;
    console.log("refresh_network_ui-->div_wifi = " + style_wifi);

    var style_ethernet = element.value == 2 ? 'block' : 'none';
    document.getElementById('div_ethernet').style.display = style_ethernet;
    console.log("refresh_network_ui-->div_ethernet = " + style_ethernet);

    refresh_network_info();
}

//var style = 'block';
//document.getElementById('div_wifi').style.display = style;

function network_select(valueToSelect) {    
    var element = document.getElementById('network');
    element.value = valueToSelect;
    refresh_network_ui(element);
}

function network_default_select() {    
    network_select(1);
}

function loadStaticFile() {
  var result = null;
  var jsonobj = null;

  var xmlhttp = new XMLHttpRequest();
  xmlhttp.open("GET", filePath, false);
  xmlhttp.send(null);
  if (xmlhttp.status==200) {
    result = xmlhttp.responseText;
    jsonobj = JSON.parse(result);
  }
  jsonobj = JSON.parse(result);
  return jsonobj;
}

function refresh_network_info() {
    console.log("refresh network info.");
    jsonobj = loadStaticFile();

    var string = "<p>";
    string += "wifi SSID   = <input type=\"text\" name=\"ssid\" value=\"" + jsonobj.wifi.ssid + "\"><br>";
    string += "wifi passwd = <input type=\"text\" name=\"pw\" value=\"" + jsonobj.wifi.pw + "\"><br>";
    string += "</p>";

    document.getElementById("form_wifi").innerHTML = string;

    var string = "<p>";
    string += "IP (static) = <input type=\"text\" name=\"ip\" value=\"" + jsonobj.ethernet.ip + "\"><br>";
    string += "netmask = <input type=\"text\" name=\"netmask\" value=\"" + jsonobj.ethernet.netmask + "\"><br>";
    string += "gateway = <input type=\"text\" name=\"gateway\" value=\"" + jsonobj.ethernet.gateway + "\"><br>";
    string += "</p>";
    document.getElementById("form_ethernet").innerHTML = string;
}

function update_ethernet() {
  var x = document.getElementById("form_ethernet");
  var outstring = "";
  outstring += "<p>";
  for (var i = 0; i < x.length; i++)  {
    outstring += "name : " + x.elements[i].name + ",  value : " + x.elements[i].value + "<br>";
  }
  
  jsonobj.ethernet.ip = x.elements[0].value;
  jsonobj.ethernet.netmask = x.elements[1].value;
  jsonobj.ethernet.gateway = x.elements[2].value;
  
  outstring += JSON.stringify(jsonobj);
  outstring += "<br>=====================<br>";

  document.getElementById("debug").innerHTML = outstring;
}

function update_wifi() {
  var x = document.getElementById("form_wifi");
  var outstring = "";
  outstring += "<p>";
  for (var i = 0; i < x.length; i++)  {
    outstring += "name : " + x.elements[i].name + ",  value : " + x.elements[i].value + "<br>";
  }
  
  jsonobj.wifi.ssid = x.elements[0].value;
  jsonobj.wifi.pw = x.elements[1].value;

  outstring += JSON.stringify(jsonobj);
  outstring += "<br>=====================<br>";
  var xmlhttp = new XMLHttpRequest();
  xmlhttp.onreadystatechange=function() {
    if (xmlhttp.readyState==4 && xmlhttp.status==200) {
      document.getElementById("return").innerHTML = xmlhttp.responseText;;
    }
  }
  xmlhttp.open('POST', "write.js", true);
  
  //xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
  xmlhttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

  //xmlhttp.send(JSON.stringify(jsonobj));
  xmlhttp.send("foo=bar&lorem=ipsum");

  // we should transfer the data into websocket, the reason is because server side can't write file directly
  function WebSocketTest() {
    if ("WebSocket" in window) {
      //alert("WebSocket is supported by your Browser!");
      console.log("WebSocket is supported by your Browser!");
      // Let us open a web socket
      var ws = new WebSocket("ws://localhost:9091");

      ws.onopen = function()
      {
      // Web Socket is connected, send data using send()
      ws.send("Message to send");
      console.log("Message is sent...");
      };

      ws.onmessage = function (evt) 
      { 
      var received_msg = evt.data;
      console.log("Message is received...");
      };

      ws.onclose = function()
      { 
      // websocket is closed.
      console.log("Connection is closed..."); 
      };

      window.onbeforeunload = function(event) {
      socket.close();
      };
    }
    else {
      // The browser doesn't support WebSocket
      alert("WebSocket NOT supported by your Browser!");
    }
  }

  WebSocketTest();

  document.getElementById("debug").innerHTML = outstring;
}

</script>

</body>
</html>