<!DOCTYPE html>
<html lang="en" class="bg-color">
<head>
  <meta charset="UTF-8">
  <title>SoolSang Web UI</title>
 
<style >
* {
  box-sizing: border-box;
  padding: 0;
  margin: 0;
}

body {
  font-family: 'Open Sans', sans-serif;
  color: #494949;
  padding: 100px 20px;
  font-size: 25px;
  vertical-align:center;
}

nav {
  z-index: 9;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  color: white;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  padding: 20px 0;
  text-align: center;
}

.bg-color {
  background-color: #1780E0;
  transition-duration: .5s;
}

.text-color {
  color: #494949;
  transition-duration: .5s;
}

footer {
  padding: 40px 0;
  text-align: center;
  opacity: .77;
  color: white;
}

.wrapper {
  min-width: 600px;
  max-width: 900px;
  margin: 0 auto;
}

.tabs {
  line-height: 30px;
  border:1px solid #494949;
  vertical-align:middle;
  display: table;
  table-layout: fixed;
  width: 100%;
  -webkit-transform: translateY(5px);
  transform: translateY(5px);
}
.tabs > li {
  transition-duration: .25s;
  display: table-cell;
  border:1px solid #494949;
  border-collapse : collapse;
  list-style: none;
  text-align: center;
  vertical-align:middle;
  padding: 10px 20px 15px 20px;
  position: relative;
  overflow: hidden;
  cursor: pointer;
  color: white;
  white-space: nowrap;
}
.tabs > li:before {
  z-index: -1;
  position: absolute;
  content: "";
  width: 100%;
  height: 120%;
  top: 0;
  left: 0;
  background-color: rgba(255, 255, 255, 0.3);
  -webkit-transform: translateY(100%);
  transform: translateY(100%);
  transition-duration: .25s;
}
.tabs > li:hover:before {
  -webkit-transform: translateY(70%);
  transform: translateY(70%);
}
.tabs > li.active {
  color: #494949;
}

.tabs > li.active:before {
  transition-duration: .5s;
  background-color: white;
  -webkit-transform: translateY(0);
  transform: translateY(0);
}

.tab__content {
  background-color: white;
  position: relative;
  width: 100%;
  border:2px solid #444444;
}
.tab__content > li {
  width: 100%;
  position: absolute;
  top: 0;
  left: 0;
  display: none;
  list-style: none;
}
.tab__content > li .content__wrapper {
  text-align: center;
  width: 100%;
  height:350px;
  padding:40px 40px;
  background-color: white;
}

.attend h2 {
  width: 100%;
  margin:0 auto;
  text-align: center;
  font-weight: 300;
  position:relative;
  padding-bottom:20px;
}
.gameicon img {
  width: 150px;
  height: auto;
  padding-bottom:20px;
  position:relative;
}

.randombutton {
  background: #2EAFA3;
  border:0;
  border-radius:10px;
  color:white;
  text-align: center;
  position:relative;
  font-size:20px;
  margin:0 auto;
  padding:10px 100px;
}

.randombutton:active {
  background-color: #a5e5df;
}

.lovebutton {
  background: #C11F61;
  border:0;
  border-radius:10px;
  color:white;
  text-align: center;
  position:relative;
  font-size:20px;
  margin:0 auto;
  padding:10px 100px;
}

.lovebutton:active {
  background-color: #f7b7d1;
}

.colors-name {
  text-align: center;
}
.colors-name > li {
  list-style: none;
  display: inline-block;
  margin: 0 30px;
}

.colors {
  text-align: center;
  font-size:0.6em;
}

.mytable table {
  width: 100%;
  border: 1px solid #444444;
  border-collapse: collapse;
}

.mytable th {
    width: 5%;
    background-color: #1780E0;
    color:#FFFFFF;
}

.mytable,.mytable th,.mytable td {
  font-size:0.95em;
  text-align:center;
  padding:4px;
  border-collapse:collapse;
  margin-bottom:20px;
}

.mytable th,.mytable td {
  border: 1px solid #1B94EF;
  border-width: 1px 0 1px 0
  margin:10px;
}
.mytable tr {
  border: 1px solid #1B94EF;
  color: #494949
}
.mytable tr:nth-child(odd) {
  background-color:#fdfdfd;
}
.mytable tr:nth-child(even) {
  background-color:#b4e0fe;
}
select {
  width:100px;
  height:30px;
  padding-left:10px;
  font-size:18px;
  color:#494949;
  border:1px solid #006fff;
  border-radius:3px;
}
.settingbutton {
  background: #1780E0;
  border:0;
  border-radius:10px;
  color:white;
  padding:10px 35px; 
  position:relative;
  font-size:20px;
  text-align:relative;
  text-align: center;
  text-decoration:none;
  display:inline-block;
  font-size:20px;
  outline:none;
}

.settingbutton:active {
  background-color: #7fbcf4;
}

</style>
<script>
  window.console = window.console || function(t) {};
</script>
  
<script>
  if (document.location.search.match(/type=embed/gi)) {
    window.parent.postMessage("resize", "*");
  }
</script>


</head>
<body translate="no" >

  <nav class="bg-color"></br>Joyful SoolSang</nav>

<section class="wrapper">
    <ul class="tabs">
        <li><p>Random</p><p>Game</p></li>
        <li><p>Love Shot</p><p>Game</p></li>
        <li class="active"><p>Settings</p></li>
    </ul>

    <ul class="tab__content">
        <li>
            <div class="content__wrapper">
                <div class="attend">
                  <h2 id=rg_text>XX 명 게임 참여 중</h2>
                </div>
                <div class="gameicon">
                  <img id=rg_img src="images/icon_rg_nor.png" />
                </div>
                <div>
                  <button class="randombutton" id="rg_game_bt">Ready</button>
                </div>
            </div>
        </li>
        <li>
            <div class="content__wrapper">
                <div class="attend">
                  <h2 id=lg_text>XX 명 게임 참여 중</h2>
                </div>
                <div class="gameicon">
                  <img id=lg_img src="images/icon_lg_nor.png" />
                </div>
                <div>
                  <button class="lovebutton" id="lg_game_bt">Ready</button>
                </div>
            </div>
        </li>        
        <li class="active">
            <div class="content__wrapper">
                <div class="cups">
                </div>
                <div>
                  <button class="settingbutton" id="send">SETTING</button>
                  <button class="settingbutton" id="restart">RESTART</button>
                </div>
            </div>
        </li>
        
    </ul>
    <footer class="footer">Created by Sooldongmoo</footer>
</section>
  <script src="./codepen.js"></script>
  <script src='./jquery-3.3.1.min.js'></script>
  <script>
    $(document).ready(function () {
        // Variables
        var clickedTab = $(".tabs > .active");
        var tabWrapper = $(".tab__content");
        var activeTab = tabWrapper.find(".active");
        var activeTabHeight = activeTab.outerHeight();
        // Show tab on page load
        activeTab.show();
        reload();

        // Set height of wrapper on page load
        tabWrapper.height(activeTabHeight);

        $(".tabs > li").on("click", function () {

            // Remove class from active tab
            $(".tabs > li").removeClass("active");
            $(".colors > li").removeClass("active-color");
            
            
            $(".bg-color").css("background-color", "#1780E0");

            // Add class active to clicked tab
            $(this).addClass("active");

            // Update clickedTab variable
            clickedTab = $(".tabs .active");

            // fade out active tab
            activeTab.fadeOut(250, function () {
                // Remove active class all tabs
                $(".tab__content > li").removeClass("active");

                // Get index of clicked tab
                var clickedTabIndex = clickedTab.index();
                // Add class active to corresponding tab
                $(".tab__content > li").eq(clickedTabIndex).addClass("active");

                // update new active tab
                activeTab = $(".tab__content > .active");
                console.log(activeTab);
                // Update variable
                activeTabHeight = activeTab.outerHeight();

                // Animate height of wrapper to new tab height
                tabWrapper.stop().delay(50).animate({
                    height: activeTabHeight },
                    500, function () {
                    // Fade in active tab
                    activeTab.delay(50).fadeIn(250);

                });

                if (clickedTabIndex == 0) { // random game
                  console.log("random");
                  checkCups("#rg_text");
                  $(".bg-color").css("background-color", "#2EAFA3");
                  $(".gamebutton").css("background", "#2EAFA3");
                  $('#rg_img').attr("src","images/icon_rg_nor.png");

                } else if (clickedTabIndex == 1) { // love shot game
                  console.log("lovshot");
                  checkCups("#lg_text");
                  $(".bg-color").css("background-color", "#C11F61");
                  $(".gamebutton").css("background", "#C11F61");
                  $('#lg_img').attr("src","images/icon_lg_nor.png");
                } else if (clickedTabIndex == 2) { // setting
                  console.log("setting");
                  reload();
                }

            });
        });

        // Variables
        var colorButton = $(".colors li");
        colorButton.on("click", function () {
          // Remove class from currently active button
          $(".colors > li").removeClass("active-color");
          // Add class active to clicked button
          $(this).addClass("active-color");
          // Get background color of clicked
          var newColor = $(this).attr("data-color");
          // Change background of everything with class .bg-color
          $(".bg-color").css("background-color", newColor);
          // Change color of everything with class .text-color
        });
    });
    
    function reload() {
      var filePath = "cups.json"
      var result = null;
      var jsonobj = null;
      var xmlhttp = new XMLHttpRequest();

      console.log("cups.json path : " + filePath);

      xmlhttp.onreadystatechange = function() {
        console.log("xmlhttp.status =" + this.status);
        if (this.readyState == 4 && this.status == 200) {
          console.log("xmlhttp.responseText =" + this.responseText);
          result = xmlhttp.responseText;
          jsonobj = JSON.parse(result);

          display(jsonobj);
          console.log("reload completed~~~");
        }
      };
      xmlhttp.open("GET", filePath, true);
      xmlhttp.send();
    }

    function checkCups(tabs) {
      var cnt = 0;
      var filePath = "cups.json"
      var result = null;
      var jsonobj = null;
      var xmlhttp = new XMLHttpRequest();

      xmlhttp.onreadystatechange = function() {
        console.log("xmlhttp.status =" + this.status);
        if (this.readyState == 4 && this.status == 200) {
          console.log("xmlhttp.responseText =" + this.responseText);
          result = xmlhttp.responseText;
          jsonobj = JSON.parse(result);

          for (j in jsonobj.Lists) {
            cnt++;
          }
          console.log("cup is" + cnt);
          var inputString = cnt + "명 게임 참여 중";
          $(tabs).text(inputString);
           $('#rg_text').text(inputString);
        }
      };

      xmlhttp.open("GET", filePath, true);
      xmlhttp.send();
    }

    function test() {
      alert("test");
    }

    function readTextFile(file, callback) {
      var rawFile = new XMLHttpRequest();
      rawFile.overrideMimeType("application/json");
      rawFile.open("GET", file, true);
      rawFile.onreadystatechange = function() {
          if (rawFile.readyState === 4 && rawFile.status == "200") {
              callback(rawFile.responseText);
          }
      }
      rawFile.send(null);
    }

    function display(jsonobj) {
      var outstring;

      console.log("reload cup lists~~~");

      outstring = "<div class=cups><table class=mytable><thead><tr>";
      outstring += "<tr><th>ID</th><th>IP</th><th>How much can you drink?</th></thead><tbody>"

      for (j in jsonobj.Lists) {
          outstring += "<tr>";
          outstring += "<td>" + jsonobj.Lists[j].Name + "</td>";
          outstring += "<td>" + jsonobj.Lists[j].IPAddress + "</td>";
          outstring += "<td><select name='number' id=number" + j + "><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option></select></td>";
          outstring += "</tr>"
      }
      outstring += "</tbody></table></div>"
 
      $('.cups').html(outstring);
    }

    function sleep(delay) {
      var start = new Date().getTime();
      while (new Date().getTime() < start + delay);
    }

    window.addEventListener("load", function(evt) {
      var conn;

      conn = new WebSocket("ws://" + document.location.host + "/ws");
      conn.onclose = function (evt) {
          console.log("Close websocket");
      };
      conn.onmessage = function (evt) {
          var messages = evt.data.split('\n');
          for (var i = 0; i < messages.length; i++) {
              var item = document.createElement("div");
              item.innerText = messages[i];
              appendLog(item);
          }
      };

      document.getElementById("send").onclick = function(evt) {
          if (!conn) {
            return false;
          }
          // json create and send through ws
          var obj = new Object();
          obj.cmd = "usersetting";
          //usage:
          readTextFile("cups.json", function(text){
              var data = JSON.parse(text);
              console.log(data);
              var cap = [];

              for (j in data.Lists) {
                var id = "number" + j;
                console.log(id);
                cap.push(Number(document.getElementById(id).value));
              }

              obj.cap = cap;
              console.log(obj);
              var jsonString = JSON.stringify(obj);

              conn.send(jsonString);
          });

          
          return false;
      };

      document.getElementById("restart").onclick = function(evt) {
          if (!conn) {
            return false;
          }

          var obj = new Object();
          obj.cmd = "restart";
          var jsonString = JSON.stringify(obj);

          conn.send(jsonString);

          return false;
      };

      document.getElementById("rg_game_bt").onclick = function(evt) {
        console.log("randombutton");
        if (!conn) {
          return false;
        }
        var name = $('#rg_game_bt').text();
        console.log(name);

        var obj = new Object();
        obj.cmd = "gamesetting";
        clickedGame = $(".colors .active-color");
        obj.kind = 1; //random game
        
        if (name == "Ready") {
          obj.state = 0; // ready
          $('#rg_game_bt').text("Start");
          $('#rg_img').attr("src","images/icon_rg_ready.png");
          readTextFile("cups.json", function(text){
            var data = JSON.parse(text);
            console.log(data);
            console.log("length :" + data.Lists.length);
            // select random cup to send
            var jsonString = JSON.stringify(obj);
            conn.send(jsonString);
          });
        } else if (name == "Start") {
          obj.state = 1; // ready
          $('#rg_game_bt').text("Selecting...");
          $('#rg_img').attr("src","images/icon_rg_selecting.png");
          $('#rg_game_bt').attr("disabled",true);
          $(".randombutton").css("background-color", "#a5e5df");
   
          readTextFile("cups.json", function(text){
            var data = JSON.parse(text);
            console.log(data);
            console.log("length :" + data.Lists.length);
            // select random cup to send
            var jsonString = JSON.stringify(obj);
            conn.send(jsonString);
          });
  
          setTimeout(function() {
            $('#rg_game_bt').text("Ready");
            $('#rg_img').attr("src","images/icon_rg_done.png");
            $('#rg_game_bt').attr("disabled",false);
            $(".randombutton").css("background-color", "#2EAFA3");
            
          }, 5000);
        }
      };

      document.getElementById("lg_game_bt").onclick = function(evt) {
        console.log("loveshotbutton");
        if (!conn) {
          return false;
        }
        var name = $('#lg_game_bt').text();
        console.log(name);

        var obj = new Object();
        obj.cmd = "gamesetting";
        clickedGame = $(".colors .active-color");
        obj.kind = 2; //loveshot game
        
        if (name == "Ready") {
          obj.state = 0 // ready
          $('#lg_game_bt').text("Start");
          $('#lg_img').attr("src","images/icon_lg_ready.png");
          readTextFile("cups.json", function(text){
            var data = JSON.parse(text);
            console.log(data);
            console.log("length :" + data.Lists.length);
            // select random cup to send
            var jsonString = JSON.stringify(obj);
            conn.send(jsonString);
          });
        } else if (name == "Start") {
          obj.state = 1 // ready
          $('#lg_game_bt').text("Selecting...");
          $('#lg_img').attr("src","images/icon_lg_selecting.png");
          $('#lg_game_bt').attr("disabled",true);
          $(".lovebutton").css("background-color", "#f7b7d1");

          readTextFile("cups.json", function(text){
            var data = JSON.parse(text);
            console.log(data);
            console.log("length :" + data.Lists.length);
            // select random cup to send
            var jsonString = JSON.stringify(obj);
            conn.send(jsonString);
          });

          setTimeout(function() {
            $('#lg_game_bt').text("Ready");
            $('#lg_img').attr("src","images/icon_lg_done.png");
            $('#lg_game_bt').attr("disabled",false);
            $(".lovebutton").css("background-color", "#C11F61");
            
          }, 5000);

        }
      };
    })
  </script>
</body>
</html>
